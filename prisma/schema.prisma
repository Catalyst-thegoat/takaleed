// Prisma Schema for Takaleed - Moroccan Invoicing Platform
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // For development - use PostgreSQL for production
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  companyName   String?
  ice           String?   // ICE - Identifiant Commun de l'Entreprise
  if            String?   // Identifiant Fiscal
  taxId         String?   // Tax Identification
  address       String?
  phone         String?
  logo          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clients       Client[]
  invoices      Invoice[]
  settings      Settings?
  subscriptions Subscription[]
}

model Client {
  id          String    @id @default(cuid())
  userId      String
  name        String
  email       String?
  phone       String?
  address     String?
  ice         String?   // ICE for businesses
  if          String?   // IF for businesses
  city        String?
  country     String    @default("Maroc")
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices    Invoice[]

  @@index([userId])
}

model Invoice {
  id              String    @id @default(cuid())
  invoiceNumber   String
  userId          String
  clientId        String
  status          String    @default("draft") // draft, sent, paid, overdue, cancelled
  issueDate       DateTime
  dueDate         DateTime
  
  // Moroccan specific
  taxRate         Float     @default(20) // TVA 20% standard
  taxType         String    @default("inclusive") // inclusive, exclusive
  discount        Float     @default(0)
  discountType    String    @default("percent") // percent, fixed
  
  subtotal        Float
  taxAmount       Float
  total           Float
  amountPaid      Float     @default(0)
  currency        String    @default("MAD")
  
  notes           String?
  terms           String?
  footer          String?
  
  // PDF
  pdfUrl          String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Restrict)
  items           InvoiceItem[]

  @@unique([userId, invoiceNumber])
  @@index([userId])
  @@index([clientId])
  @@index([status])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Float
  unitPrice   Float
  taxRate     Float   @default(20)
  amount      Float
  createdAt   DateTime @default(now())

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Settings {
  id              String  @id @default(cuid())
  userId          String  @unique
  businessName    String?
  businessAddress String?
  businessEmail   String?
  businessPhone   String?
  ice             String?
  if              String?
  taxOffice       String? // Service des Impôts
  logo            String?
  
  // Invoice defaults
  defaultTaxRate  Float   @default(20)
  defaultPaymentTerms Int @default(30) // days
  invoicePrefix   String  @default("INV")
  invoiceFooter   String?
  
  // Company info
  rc              String? // Registre de Commerce
  ice             String?
  patent          String? // Numéro de Patent
  centre          String? // Centre de RC
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id              String   @id @default(cuid())
  userId          String
  plan            String   @default("free") // free, pro, enterprise
  stripeCustomerId String?
  stripeSubscriptionId String?
  status          String   @default("active")
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Analytics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  
  // Daily stats
  invoicesCreated Int      @default(0)
  invoicesSent    Int      @default(0)
  invoicesPaid    Int      @default(0)
  revenue         Float    @default(0)
  
  // Monthly totals
  monthlyRevenue  Float    @default(0)
  monthlyInvoices Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
}
